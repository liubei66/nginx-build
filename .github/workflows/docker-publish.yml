name: Build and Push Nginx Image (Tag/Release/Branch)

# âœ… è§¦å‘æ¡ä»¶ï¼š
# â‘  å‘å¸ƒRelease 
# â‘¡ æ¨é€vå¼€å¤´Tag
# â‘¢ å¤šåˆ†æ”¯æäº¤åŒ…å«vX.Y.Zç‰ˆæœ¬å· (æ–°å¢)
on:
  release:
    types: [published]
  push:
    tags: ['v*']
    # ç›‘å¬å¤šåˆ†æ”¯ï¼Œå¯æ ¹æ®éœ€è¦è°ƒæ•´åˆ†æ”¯åˆ—è¡¨
    branches: ['main', 'master', 'develop', 'release/*']

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    # âœ… ä»…å½“æ˜¯releaseã€tagæˆ–commitåŒ…å«ç‰ˆæœ¬å·æ—¶è¿è¡Œ (é¿å…éç‰ˆæœ¬æäº¤è§¦å‘)
    if: |
      github.event_name == 'release' || 
      startsWith(github.ref, 'refs/tags/v') || 
      contains(github.event.head_commit.message, 'v') && 
      contains(github.event.head_commit.message, '.') && 
      !startsWith(github.event.head_commit.message, 'Merge')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      # âœ… æ™ºèƒ½é€‚é…ï¼šå¤šæºè·å–Tag
      # ä¼˜å…ˆçº§ï¼šRelease > Tagæ¨é€ > æäº¤æ¶ˆæ¯ä¸­çš„ç‰ˆæœ¬å·
      - name: Extract Tag (Multi-source)
        id: extract_tag
        run: |
          TAG_NAME=""
          
          # ä¼˜å…ˆçº§1ï¼šä»Releaseäº‹ä»¶è¯»å–Tagï¼ˆå‘å¸ƒReleaseæ—¶è§¦å‘ï¼‰
          if [ -n "${{ github.event.release.tag_name }}" ]; then
            TAG_NAME=${{ github.event.release.tag_name }}
            echo "âœ… ä»Releaseäº‹ä»¶è·å–Tag: $TAG_NAME"
          
          # ä¼˜å…ˆçº§2ï¼šä»æ¨é€çš„Tagè¯»å–ï¼ˆæ‰‹åŠ¨git push tagæ—¶è§¦å‘ï¼‰
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG_NAME=${GITHUB_REF#refs/tags/}
            echo "âœ… ä»æ¨é€çš„Tagè·å–Tag: $TAG_NAME"
          
          # ä¼˜å…ˆçº§3ï¼šä»æäº¤æ¶ˆæ¯æå–ç‰ˆæœ¬å· (æ–°å¢)
          elif [ -n "${{ github.event.head_commit.message }}" ]; then
            COMMIT_MSG="${{ github.event.head_commit.message }}"
            echo "ğŸ” æ£€æŸ¥æäº¤æ¶ˆæ¯: $COMMIT_MSG"
            
            # ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå– v å¼€å¤´çš„è¯­ä¹‰åŒ–ç‰ˆæœ¬å· (vX.Y.Z æˆ– vX.Y.Z-é¢„å‘å¸ƒ)
            if [[ $COMMIT_MSG =~ (v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9\.]+)?) ]]; then
              TAG_NAME=${BASH_REMATCH[1]}
              echo "âœ… ä»æäº¤æ¶ˆæ¯æå–åˆ°ç‰ˆæœ¬å·: $TAG_NAME"
            fi
          fi
          
          # æœªæ‰¾åˆ°æœ‰æ•ˆç‰ˆæœ¬å·æ—¶è·³è¿‡æ„å»º
          if [ -z "$TAG_NAME" ]; then
            echo "âŒ æœªæ‰¾åˆ°æœ‰æ•ˆçš„ç‰ˆæœ¬å·ï¼Œè·³è¿‡Dockeræ„å»º"
            echo "FOUND_VALID_VERSION=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼
          if [[ ! $TAG_NAME =~ ^v[0-9]+\.[0-9]+\.[0-9]+.*$ ]]; then
            echo "âš ï¸ ç‰ˆæœ¬å·æ ¼å¼ä¸æ ‡å‡†: $TAG_NAMEï¼Œä»ç»§ç»­æ„å»º"
          fi
          
          # è¾“å‡ºç‰ˆæœ¬å·ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "DOCKER_TAG=${TAG_NAME}" >> $GITHUB_ENV
          echo "FOUND_VALID_VERSION=true" >> $GITHUB_OUTPUT
          echo "âœ… æœ€ç»ˆä½¿ç”¨Docker Tagï¼š${TAG_NAME}"

      # âœ… ä»…å½“æ‰¾åˆ°æœ‰æ•ˆç‰ˆæœ¬å·æ—¶ç»§ç»­
      - name: Validate Version Extraction
        if: steps.extract_tag.outputs.FOUND_VALID_VERSION != 'true'
        run: |
          echo "æœªæå–åˆ°æœ‰æ•ˆç‰ˆæœ¬å·ï¼Œå·¥ä½œæµç»ˆæ­¢"
          exit 1

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & Push Image
        run: |
          # æ„å»ºå…ƒæ•°æ®ç”¨äºå¤šæ¶æ„æ”¯æŒ
          DOCKER_IMAGE=${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_REPO }}
          
          # ä½¿ç”¨buildxæ”¯æŒå¤šå¹³å°æ„å»º
          docker buildx build --platform linux/amd64,linux/arm64 \
            -t $DOCKER_IMAGE:${{ env.DOCKER_TAG }} \
            -t $DOCKER_IMAGE:latest \
            --push \
            .
        
        # å¢å¼ºï¼šæ·»åŠ æäº¤ä¿¡æ¯åˆ°é•œåƒæ ‡ç­¾
      - name: Inspect Image (Debug)
        if: always()
        run: |
          DOCKER_IMAGE=${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_REPO }}
          docker pull $DOCKER_IMAGE:${{ env.DOCKER_TAG }}
          echo "âœ… é•œåƒæ„å»ºå®Œæˆ: $DOCKER_IMAGE:${{ env.DOCKER_TAG }}"
          echo "ğŸ” é•œåƒè¯¦æƒ…:"
          docker inspect $DOCKER_IMAGE:${{ env.DOCKER_TAG }} | jq '.[0].Config.Labels'

      # æ–°å¢ï¼šåˆ›å»ºGitHub Releaseï¼ˆå¦‚æœæ˜¯ä»åˆ†æ”¯æäº¤è§¦å‘ï¼‰
      - name: Create GitHub Release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/heads/') && steps.extract_tag.outputs.FOUND_VALID_VERSION == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.DOCKER_TAG }}
          name: Release ${{ env.DOCKER_TAG }}
          body: |
            Dockeré•œåƒå·²æ„å»ºå¹¶æ¨é€:
            - `${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_REPO }}:${{ env.DOCKER_TAG }}`
            - `${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_REPO }}:latest`
            
            æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}
            æäº¤è€…: ${{ github.actor }}
          draft: false
          prerelease: ${{ contains(env.DOCKER_TAG, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
