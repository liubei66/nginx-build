name: Build and Push Nginx Image with Tag

# 触发条件（3种场景自动执行，覆盖所有发布需求）
on:
  # 场景1：手动创建/推送Tag时触发（核心）
  push:
    tags:
      - 'v*'  # 仅匹配 v开头的Tag，例 v1.29.4、v2.0.0
  # 场景2：手动发布Release时触发（和Tag联动，更规范）
  release:
    types: [published]
  # 场景3：可选 - 推送main分支仍触发，保持latest标签更新
  push:
    branches: [main]
    paths: ['Dockerfile']

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      # 1. 拉取仓库代码（含Dockerfile和Tag信息）
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 提取GitHub Tag名称（自动适配，无需手动改版本）
      - name: Extract Docker Tag from GitHub Tag
        id: extract_tag
        run: |
          # 优先提取Release/Tag的版本号，无则用latest
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG_NAME=${GITHUB_REF#refs/tags/}
            echo "DOCKER_TAG=$TAG_NAME" >> $GITHUB_ENV
          else
            echo "DOCKER_TAG=latest" >> $GITHUB_ENV
          fi

      # 3. 登录Docker Hub（调用已配置的密钥，无需改动）
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 4. 构建镜像（自动绑定 用户名/仓库名/版本Tag）
      - name: Build Docker Image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_REPO }}:${{ env.DOCKER_TAG }} .
          # 无论什么Tag，都同步更新latest标签（必备）
          docker tag ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_REPO }}:${{ env.DOCKER_TAG }} ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_REPO }}:latest

      # 5. 推送镜像（双Tag推送：版本Tag + latest Tag）
      - name: Push Docker Image to Docker Hub
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_REPO }}:${{ env.DOCKER_TAG }}
          docker push ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_REPO }}:latest
